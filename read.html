<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>KiKi â€” Memory Lane</title>
<style>
  :root {
    --bg-dark: #0a0b10;
    --card-bg: #14151f;
    --ki-blue: #88ccff;
    --text-main: #e0e0e0;
    --text-muted: #9090aa;
    --accent-glass: rgba(136, 204, 255, 0.1);
    --border: rgba(255, 255, 255, 0.08);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg-dark);
    color: var(--text-main);
    margin: 0;
    height: 100vh; /* Full viewport height */
    display: flex;
    flex-direction: column;
    overflow: hidden; /* Prevent body scroll, handle inside containers */
  }

  /* --- HEADER & FILTERS (Sticky Top) --- */
  header {
    background: rgba(10, 11, 16, 0.95);
    backdrop-filter: blur(15px);
    border-bottom: 1px solid var(--border);
    padding: 15px;
    z-index: 50;
    flex-shrink: 0;
  }

  .app-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--ki-blue);
    margin: 0 0 12px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .filter-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 8px;
  }

  select {
    width: 100%;
    padding: 10px;
    background: #1a1b26;
    border: 1px solid var(--border);
    color: white;
    border-radius: 8px;
    font-size: 0.9rem;
    outline: none;
    appearance: none; /* Remove default arrow */
    background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2388ccff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 10px;
  }

  /* --- FEED CONTAINER --- */
  #diaryContainer {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    padding-bottom: 80px; /* Space for bottom interaction */
    -webkit-overflow-scrolling: touch;
  }

  .loading-msg { text-align: center; color: var(--text-muted); margin-top: 40px; }

  /* --- DIARY CARD --- */
  .diary-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    position: relative;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    border-bottom: 1px solid rgba(255,255,255,0.03);
    padding-bottom: 10px;
  }

  .date-badge {
    color: var(--ki-blue);
    font-size: 0.9rem;
    font-weight: 700;
  }

  .time-stamp {
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  .diary-text {
    font-size: 1rem;
    line-height: 1.6;
    color: #d0d0e0;
    white-space: pre-wrap;
    font-weight: 300;
  }

  .revise-btn {
    margin-top: 20px;
    width: 100%;
    padding: 12px;
    background: var(--accent-glass);
    border: 1px solid rgba(136, 204, 255, 0.2);
    color: var(--ki-blue);
    border-radius: 10px;
    font-size: 0.95rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: 0.2s;
  }
  
  .revise-btn:active { background: rgba(136, 204, 255, 0.3); transform: scale(0.98); }

  /* --- CHAT OVERLAY (Responsive Bottom Sheet) --- */
  #chatPanel {
    position: fixed;
    z-index: 100;
    background: #121218;
    box-shadow: 0 -10px 40px rgba(0,0,0,0.8);
    transition: transform 0.3s cubic-bezier(0.19, 1, 0.22, 1);
    display: flex;
    flex-direction: column;
  }

  /* Desktop Styles */
  @media (min-width: 768px) {
    #chatPanel {
      top: 0; right: 0; bottom: 0;
      width: 400px;
      transform: translateX(100%);
      border-left: 1px solid var(--border);
    }
    #chatPanel.open { transform: translateX(0); }
  }

  /* Mobile Styles */
  @media (max-width: 767px) {
    #chatPanel {
      left: 0; right: 0; bottom: 0;
      height: 85vh; /* Takes up 85% of screen */
      transform: translateY(100%);
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      border-top: 1px solid var(--ki-blue);
    }
    #chatPanel.open { transform: translateY(0); }
  }

  .chat-header {
    padding: 15px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(136, 204, 255, 0.05);
    border-radius: 20px 20px 0 0;
  }

  .close-chat {
    background: none;
    border: none;
    color: white;
    font-size: 2rem;
    line-height: 1;
    padding: 0 10px;
    cursor: pointer;
  }

  #chatBox {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .msg {
    padding: 10px 14px;
    border-radius: 14px;
    max-width: 85%;
    font-size: 0.95rem;
    line-height: 1.4;
  }
  
  .ai-msg { 
    background: #1f202e; 
    color: var(--ki-blue); 
    align-self: flex-start; 
    border-bottom-left-radius: 2px;
    border: 1px solid rgba(136, 204, 255, 0.1);
  }
  
  .user-msg { 
    background: rgba(136, 204, 255, 0.1); 
    color: white; 
    align-self: flex-end; 
    border-bottom-right-radius: 2px;
  }

  .chat-input-area {
    padding: 15px;
    background: #0a0b10;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 10px;
    align-items: flex-end;
  }

  .chat-input-area textarea {
    flex: 1;
    background: #1a1b26;
    border: none;
    color: white;
    border-radius: 20px;
    padding: 12px 15px;
    font-size: 1rem;
    resize: none;
    outline: none;
    font-family: inherit;
    max-height: 100px;
  }

  #sendChatBtn {
    background: var(--ki-blue);
    color: #000;
    border: none;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    font-weight: bold;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

</style>
</head>
<body>

<header>
  <div class="app-title">
    <span>KiKi ðŸŒ™ Memories</span>
  </div>
  <div class="filter-row">
    <select id="yearSelect"><option value="">Year</option></select>
    <select id="monthSelect"><option value="">Month</option></select>
    <select id="daySelect"><option value="">Day (All)</option></select>
  </div>
</header>

<div id="diaryContainer">
  <div class="loading-msg">Select a Year and Month to start.</div>
</div>

<div id="chatPanel">
  <div class="chat-header">
    <span style="font-weight:600; color:var(--ki-blue);">Reflecting...</span>
    <button class="close-chat" id="closeChat">&times;</button>
  </div>
  <div id="chatBox"></div>
  <div class="chat-input-area">
    <textarea id="chatInput" rows="1" placeholder="Type here..."></textarea>
    <button id="sendChatBtn">âž¤</button>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient("https://fjvajzjaqfrwrvgotjvt.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqdmFqemphcWZyd3J2Z290anZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MjY1NzUsImV4cCI6MjA4NDUwMjU3NX0.BHUUf57gi7Knvoc_DG_6B-hYuUzMS6TC_Lfjvf56rlI");
const API_KEY = "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";

// DOM Elements
const yearSelect = document.getElementById("yearSelect");
const monthSelect = document.getElementById("monthSelect");
const daySelect = document.getElementById("daySelect");
const diaryContainer = document.getElementById("diaryContainer");
const chatPanel = document.getElementById("chatPanel");
const chatBox = document.getElementById("chatBox");

// State
let currentMonthEntries = []; // Store fetched entries locally for fast day filtering
let currentChatHistory = [];

// 1. Load Years on Start
async function loadYears() {
  const { data, error } = await supabase
    .from("diary_entries")
    .select("year")
    .order("year", { ascending: false });

  if (error) return;
  const years = [...new Set(data.map(d => d.year))];
  
  yearSelect.innerHTML = '<option value="">Year</option>';
  years.forEach(y => {
    yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
  });
}

// 2. Load Months when Year Selected
async function loadMonths(year) {
  monthSelect.innerHTML = '<option value="">Loading...</option>';
  daySelect.innerHTML = '<option value="">Day (All)</option>'; // Reset days
  
  if (!year) {
    monthSelect.innerHTML = '<option value="">Month</option>';
    return;
  }

  const { data, error } = await supabase
    .from("diary_entries")
    .select("month, month_name")
    .eq("year", year)
    .order("month", { ascending: true });

  if (error) return;

  const seen = new Set();
  monthSelect.innerHTML = '<option value="">Month</option>';
  
  data.forEach(d => {
    if (!seen.has(d.month)) {
      seen.add(d.month);
      monthSelect.innerHTML += `<option value="${d.month}">${d.month_name}</option>`;
    }
  });
}

// 3. Load Entries AND Populate Days
async function loadEntriesAndDays(year, month) {
  diaryContainer.innerHTML = '<div class="loading-msg">Fetching memories...</div>';
  daySelect.innerHTML = '<option value="">Day (All)</option>'; // Reset Day Filter
  
  if(!year || !month) return;

  // Fetch ALL entries for this month
  const { data, error } = await supabase
    .from("diary_entries")
    .select("*")
    .eq("year", year)
    .eq("month", month)
    .order("entry_date", { ascending: false }); // Newest first
  
  if(error) { 
    diaryContainer.innerHTML = '<div class="loading-msg">Error loading. Check net.</div>'; 
    return; 
  }
  
  currentMonthEntries = data; // Save to state

  if(data.length === 0) {
    diaryContainer.innerHTML = '<div class="loading-msg">No entries found.</div>';
    return;
  }

  // Populate Day Dropdown (Unique days only)
  const days = new Set();
  data.forEach(entry => {
    const d = new Date(entry.entry_date).getDate();
    days.add(d);
  });
  
  // Sort days numeric
  [...days].sort((a,b) => b - a).forEach(d => {
    daySelect.innerHTML += `<option value="${d}">${d}</option>`;
  });

  // Render All
  renderFeed(currentMonthEntries);
}

// 4. Render Feed (Client Side Filtering)
function renderFeed(entries) {
  diaryContainer.innerHTML = "";
  
  if(entries.length === 0) {
    diaryContainer.innerHTML = '<div class="loading-msg">No entries for this specific day.</div>';
    return;
  }

  entries.forEach(entry => {
    const dateObj = new Date(entry.entry_date);
    const dateStr = dateObj.toLocaleDateString('en-US', { weekday:'short', day:'numeric', month:'short' });
    const timeStr = entry.entry_time ? entry.entry_time.slice(0,5) : "";
    const safeText = entry.diary_text.replace(/</g, "&lt;").replace(/>/g, "&gt;");

    const card = document.createElement("div");
    card.className = "diary-card";
    card.innerHTML = `
      <div class="card-header">
        <span class="date-badge">${dateStr}</span>
        <span class="time-stamp">${timeStr}</span>
      </div>
      <div class="diary-text">${safeText}</div>
      <button class="revise-btn" data-id="${entry.id}">
        <span>âœ¨ Chat with KiKi</span>
      </button>
    `;

    // Click event for AI Chat
    card.querySelector(".revise-btn").onclick = () => openChat(entry);
    diaryContainer.appendChild(card);
  });
}

// 5. Handle Day Filter Change
daySelect.addEventListener("change", (e) => {
  const selectedDay = e.target.value;
  
  if(!selectedDay) {
    // Show all
    renderFeed(currentMonthEntries);
  } else {
    // Filter locally
    const filtered = currentMonthEntries.filter(entry => {
      const d = new Date(entry.entry_date).getDate();
      return d == selectedDay;
    });
    renderFeed(filtered);
  }
});

// --- AI CHAT LOGIC ---
function openChat(entry) {
  chatPanel.classList.add("open");
  chatBox.innerHTML = "";
  
  const sysMsg = { role: "system", content: "You are KiKi. Help Boss reflect on this diary entry. Be brief, warm, and insightful." };
  const userMsg = { role: "user", content: `My diary entry: "${entry.diary_text}". How should I feel about this now?` };
  
  currentChatHistory = [sysMsg, userMsg];
  askKiKi(currentChatHistory);
}

async function askKiKi(messages) {
  const loader = document.createElement("div");
  loader.className = "msg ai-msg";
  loader.innerHTML = "<i>Reading...</i>";
  loader.id = "loader";
  chatBox.appendChild(loader);

  try {
    const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: { "Authorization": `Bearer ${API_KEY}`, "Content-Type": "application/json" },
      body: JSON.stringify({ model: "xiaomi/mimo-v2-flash:free", messages: messages })
    });
    const data = await res.json();
    document.getElementById("loader").remove();
    
    const reply = data.choices[0].message.content;
    appendMsg("ai", reply);
    currentChatHistory.push({ role: "assistant", content: reply });
  } catch(e) {
    if(document.getElementById("loader")) document.getElementById("loader").remove();
    appendMsg("ai", "Connection failed.");
  }
}

function appendMsg(role, text) {
  const div = document.createElement("div");
  div.className = `msg ${role === 'ai' ? 'ai-msg' : 'user-msg'}`;
  div.innerHTML = text.replace(/\n/g, "<br>");
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

// UI Events
document.getElementById("closeChat").onclick = () => chatPanel.classList.remove("open");
document.getElementById("sendChatBtn").onclick = () => {
  const val = document.getElementById("chatInput").value.trim();
  if(!val) return;
  appendMsg("user", val);
  currentChatHistory.push({ role: "user", content: val });
  document.getElementById("chatInput").value = "";
  askKiKi(currentChatHistory);
};

yearSelect.addEventListener("change", (e) => loadMonths(e.target.value));
monthSelect.addEventListener("change", (e) => loadEntriesAndDays(yearSelect.value, e.target.value));

loadYears();
</script>
</body>
</html>
